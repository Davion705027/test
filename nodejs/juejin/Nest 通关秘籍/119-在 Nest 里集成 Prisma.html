<header>
        <style>
            .markdown-body{
                width: 80%;
                margin: auto;
            }
            .code-block-extension-header{
                display: none;
            }
        </style>
    </header><div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们学 Prisma，最终还是要和 Nest 结合用的，就像我们学 TypeORM 时那样。</p>
<p>其实也很简单，还是基于 schema 生成 client 的 api，然后调用这些 api 来 CRUD。</p>
<p>只不过 Nest 里的调用方式不大一样。</p>
<p>我们新建个 nest 项目：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">nest <span class="hljs-keyword">new</span> nest-prisma-test</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/089216ef997c41be989759f60a74b76e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=846&amp;h=666&amp;s=266810&amp;e=png&amp;b=020202" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>进入项目，安装 prisma</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install prisma <span class="hljs-attr">--save-dev</span></span>
</code></pre>
<p>然后执行 init 创建 schema 文件：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">csharp</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-csharp code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx prisma <span class="hljs-keyword">init</span></span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea10e80f6fd04d7892d98c540a50c1ad~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1068&amp;h=504&amp;s=98914&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3209bcf5edca44bb8d55d080464cfb3d~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1220&amp;h=536&amp;s=111764&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>改下 .env 的配置：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">ini</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-ini code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-attr">DATABASE_URL</span>=<span class="hljs-string">"mysql://root:guang@localhost:3306/prisma_test"</span></span>
</code></pre>
<p>并且修改下 schema 里的 datasource 部分：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">ini</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-ini code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">datasource db {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  <span class="hljs-attr">provider</span> = <span class="hljs-string">"mysql"</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-attr">url</span>      = env(<span class="hljs-string">"DATABASE_URL"</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
</code></pre>
<p>然后创建 model：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c549d1d792aa4eb8b177c67ae9a7faee~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1406&amp;h=920&amp;s=183023&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">java</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-java code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">generator client {</span>
<span class="code-block-extension-codeLine" data-line-num="2">  provider = <span class="hljs-string">"prisma-client-js"</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">}</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">datasource db {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  provider = <span class="hljs-string">"mysql"</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">  url      = env(<span class="hljs-string">"DATABASE_URL"</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">model Department {</span>
<span class="code-block-extension-codeLine" data-line-num="11">  id        Int    <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(autoincrement())</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">  name      String  <span class="hljs-meta">@db</span>.VarChar(<span class="hljs-number">20</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="13">  createTime DateTime <span class="hljs-meta">@default(now())</span></span>
<span class="code-block-extension-codeLine" data-line-num="14">  updateTime DateTime <span class="hljs-meta">@updatedAt</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">  employees     Employee[]</span>
<span class="code-block-extension-codeLine" data-line-num="16">}</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">model Employee {</span>
<span class="code-block-extension-codeLine" data-line-num="19">  id         Int       <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(autoincrement())</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">  name      String     <span class="hljs-meta">@db</span>.VarChar(<span class="hljs-number">20</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="21">  phone     String     <span class="hljs-meta">@db</span>.VarChar(<span class="hljs-number">30</span>)  </span>
<span class="code-block-extension-codeLine" data-line-num="22"></span>
<span class="code-block-extension-codeLine" data-line-num="23">  deaprtmentId Int</span>
<span class="code-block-extension-codeLine" data-line-num="24">  department     Department      <span class="hljs-meta">@relation(fields: [deaprtmentId], references: [id])</span></span>
<span class="code-block-extension-codeLine" data-line-num="25">}</span>
</code></pre>
<p>这里就是 Department、Employee 两个 model，之间是一对多的关系。</p>
<p>然后先 migrate reset，重置下数据库：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">perl</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-perl code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx prisma migrate <span class="hljs-keyword">reset</span> </span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb18945e33674215bf629c4c44146940~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1162&amp;h=584&amp;s=89806&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后创建新的 migration:</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">csharp</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-csharp code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx prisma migrate dev --name <span class="hljs-keyword">init</span></span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dee7c45a681f432596ed1a5e94d49477~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1134&amp;h=498&amp;s=77658&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这时候数据库就就有这两个表了：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9dce99f9e864813855eecba63ed88a7~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1088&amp;h=428&amp;s=135687&amp;e=png&amp;b=eceae9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c81ec506a8b4421bb748af4c2077f83~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1020&amp;h=396&amp;s=122940&amp;e=png&amp;b=eeebeb" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>外键约束也创建好了：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff8151898fa241e3acc44f4964299c6f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1822&amp;h=358&amp;s=112063&amp;e=png&amp;b=f2f0f0" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>并且 migrate dev 还会生成 client 代码，接下来我们就可以直接来做 CRUD 了。</p>
<p>问题来了：之前我们都是直接 ts-node 跑的一个脚本，里面调用 client 的 api 来做 CRUD，现在和 Nest 集成后怎么做呢？</p>
<p>很简单，创建个 Service 就好了。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">nest g service prisma <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span></span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e373e6c5051744d6b466a0cc0af56f12~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=692&amp;h=94&amp;s=27645&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>改下 PrismaService，继承 PrismaClient，这样它就有 crud 的 api 了：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">OnModuleInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4">@<span class="hljs-title class_">Injectable</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PrismaClient</span> implements <span class="hljs-title class_">OnModuleInit</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">        <span class="hljs-variable language_">super</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="9">            <span class="hljs-attr">log</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="10">                {</span>
<span class="code-block-extension-codeLine" data-line-num="11">                    <span class="hljs-attr">emit</span>: <span class="hljs-string">'stdout'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="12">                    <span class="hljs-attr">level</span>: <span class="hljs-string">'query'</span></span>
<span class="code-block-extension-codeLine" data-line-num="13">                }</span>
<span class="code-block-extension-codeLine" data-line-num="14">            ]</span>
<span class="code-block-extension-codeLine" data-line-num="15">        })</span>
<span class="code-block-extension-codeLine" data-line-num="16">    }</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="19">        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$connect();</span>
<span class="code-block-extension-codeLine" data-line-num="20">    }</span>
<span class="code-block-extension-codeLine" data-line-num="21">}</span>
</code></pre>
<p>在 constructor 里设置 PrismaClient 的 log 参数，也就是打印 sql 到控制台。</p>
<p>在 onModuleInit 的生命周期方法里调用 $connect 来连接数据库。</p>
<p>然后再创建两个 service：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">nest g service department <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span></span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76f386beb84444cdb5a33d6d2905e232~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=736&amp;h=94&amp;s=25816&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">nest g service employee <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span></span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ae95fadb1c540c192b28663542c0152~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=686&amp;h=106&amp;s=30956&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这俩 service 里注入 PrismaService，不就可以 CRUD 了么？</p>
<p>改下 DepartmentService：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma.service'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Prisma</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">@<span class="hljs-title class_">Injectable</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DepartmentService</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">    @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">PrismaService</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="9">    private <span class="hljs-attr">prisma</span>: <span class="hljs-title class_">PrismaService</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">data: Prisma.DepartmentCreateInput</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="12">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">department</span>.<span class="hljs-title function_">create</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="13">            data,</span>
<span class="code-block-extension-codeLine" data-line-num="14">            <span class="hljs-attr">select</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="15">                <span class="hljs-attr">id</span>: <span class="hljs-literal">true</span></span>
<span class="code-block-extension-codeLine" data-line-num="16">            }</span>
<span class="code-block-extension-codeLine" data-line-num="17">        });</span>
<span class="code-block-extension-codeLine" data-line-num="18">    }</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>
<p>插入数据之后，再把 id 查询出来返回。</p>
<p>这里的 data 的 ts 类型不用自己定义，生成的 client 代码里有。</p>
<p>输入 Prisma.Deparment 就会提示出来</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed0d441e0e0648e49f8f22a26e29c1ea~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1066&amp;h=408&amp;s=104579&amp;e=png&amp;b=202020" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>还有 EmployeeService：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma.service'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Prisma</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">@<span class="hljs-title class_">Injectable</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeService</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="7"></span>
<span class="code-block-extension-codeLine" data-line-num="8">    @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">PrismaService</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="9">    private <span class="hljs-attr">prisma</span>: <span class="hljs-title class_">PrismaService</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">data: Prisma.EmployeeCreateInput</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="12">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">employee</span>.<span class="hljs-title function_">create</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="13">            data,</span>
<span class="code-block-extension-codeLine" data-line-num="14">            <span class="hljs-attr">select</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="15">                <span class="hljs-attr">id</span>: <span class="hljs-literal">true</span></span>
<span class="code-block-extension-codeLine" data-line-num="16">            }</span>
<span class="code-block-extension-codeLine" data-line-num="17">        });</span>
<span class="code-block-extension-codeLine" data-line-num="18">    }</span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
<span class="code-block-extension-codeLine" data-line-num="20"></span>
</code></pre>
<p>也定义了 create 方法。</p>
<p>然后在 AppController 里注入这俩 service：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64bbe39372e04d8884c7a31b839ae9c6~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1112&amp;h=1060&amp;s=180016&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>声明一个 create 的路由，里面创建一个 department，再创建一个 employee。</p>
<p>empolyee 通过 id 关联这个 department。</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DepartmentService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./department.service'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">EmployeeService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./employee.service'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6">@<span class="hljs-title class_">Controller</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="7"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="8">  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">private readonly appService: AppService</span>) {}</span>
<span class="code-block-extension-codeLine" data-line-num="9"></span>
<span class="code-block-extension-codeLine" data-line-num="10">  @<span class="hljs-title class_">Get</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="11">  <span class="hljs-title function_">getHello</span>(): string {</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">appService</span>.<span class="hljs-title function_">getHello</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="13">  }</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">  @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">DepartmentService</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="16">  private <span class="hljs-attr">departmentService</span>: <span class="hljs-title class_">DepartmentService</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">  @<span class="hljs-title class_">Inject</span>(<span class="hljs-title class_">EmployeeService</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="19">  private <span class="hljs-attr">employeeService</span>: <span class="hljs-title class_">EmployeeService</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="20"></span>
<span class="code-block-extension-codeLine" data-line-num="21">  @<span class="hljs-title class_">Get</span>(<span class="hljs-string">'create'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="22">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="23">    <span class="hljs-keyword">const</span> department = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">departmentService</span>.<span class="hljs-title function_">create</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="24">      <span class="hljs-attr">name</span>: <span class="hljs-string">'技术部'</span></span>
<span class="code-block-extension-codeLine" data-line-num="25">    });</span>
<span class="code-block-extension-codeLine" data-line-num="26"></span>
<span class="code-block-extension-codeLine" data-line-num="27">    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">employeeService</span>.<span class="hljs-title function_">create</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="28">      <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="29">      <span class="hljs-attr">phone</span>: <span class="hljs-string">'13222222222'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="30">      <span class="hljs-attr">department</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="31">        <span class="hljs-attr">connect</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="32">          <span class="hljs-attr">id</span>: department.<span class="hljs-property">id</span></span>
<span class="code-block-extension-codeLine" data-line-num="33">        }</span>
<span class="code-block-extension-codeLine" data-line-num="34">      }</span>
<span class="code-block-extension-codeLine" data-line-num="35">    });</span>
<span class="code-block-extension-codeLine" data-line-num="36"></span>
<span class="code-block-extension-codeLine" data-line-num="37">    <span class="hljs-keyword">return</span> <span class="hljs-string">'done'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="38">  }</span>
<span class="code-block-extension-codeLine" data-line-num="39">}</span>
</code></pre>
<p>把 nest 项目跑起来：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm run start:dev</span>
</code></pre>
<p>浏览器访问下 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2Fcreate" target="_blank" rel="nofollow noopener noreferrer" title="http://localhost:3000/create" ref="nofollow noopener noreferrer">http://localhost:3000/create</a></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97accd6e7c8844c4a2a108dfe1ed31b8~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=636&amp;h=212&amp;s=17925&amp;e=png&amp;b=ffffff" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>生成了 2 条 insert 语句：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82fe7c328ea74a11919c048fd0c18ebe~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1362&amp;h=616&amp;s=209330&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 mysql workbench 里也可以看到插入的 2 条记录：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a32a07bb02346e4ab1746333f0c3f0a~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=800&amp;h=196&amp;s=58378&amp;e=png&amp;b=f8f8f8" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e75179a690674f8ca1cb536ec795c181~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=572&amp;h=226&amp;s=39386&amp;e=png&amp;b=f6f6f6" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这样，prisma 和 nest 的集成就完成了。</p>
<p>当然，我们只是测试了 create 方法，其余的 api 也是一样的，就不展开了。</p>
<p>案例代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fnestjs-course-code%2Ftree%2Fmain%2Fnest-prisma-test" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/nest-prisma-test" ref="nofollow noopener noreferrer">小册仓库</a></p>
<h2 data-id="heading-0">总结</h2>
<p>这节我们做了 Prisma 和 Nest 的集成。</p>
<p>其实还是先用 prisma init 创建 schema 文件，然后修改 model 后用 prisma migrate dev 同步到数据库和生成 client 代码。</p>
<p>只不过之后使用 client 代码的方式不同。</p>
<p>我们创建了个 Service 继承 PrismaClient，在 constructor 里设置初始化参数。</p>
<p>之后把这个 service 的实例注入到别的 service 里，就可以做 CRUD 了。</p>
<p>这样，Prisma 怎么和 Nest 集成，我们就学会了。</p></div>