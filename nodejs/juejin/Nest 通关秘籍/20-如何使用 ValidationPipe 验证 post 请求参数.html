<header>
        <style>
            .markdown-body{
                width: 80%;
                margin: auto;
            }
            .code-block-extension-header{
                display: none;
            }
        </style>
    </header><div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上节我们学了 pipe 来对参数做验证和转换，但那些都是 get 请求的参数，如果是 post 请求呢？</p>
<p>post 请求的数据是通过 @Body 装饰器来取，并且要有一个 dto class 来接收：</p>
<p>（dto 是 data transfer object，数据传输对象的意思）</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89880e17ce6c458dbbdd098a4cca78b3~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc0b0df7fa5b468f87ea5f36d3329886~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>我们用 postman 来发个 post 请求。</p>
<p>(postman 在这里下载： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.postman.com%2Fdownloads" target="_blank" rel="nofollow noopener noreferrer" title="https://www.postman.com/downloads" ref="nofollow noopener noreferrer">www.postman.com/downloads</a>)</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/745b9d9702b54dde8d84ef37df47bd84~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>content-type 指定为 json。</p>
<p>点击 send，就可以看到服务端接收到了数据，并且把它转为了 dto 类的对象：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cb9b7d08313499a93ccefb04e6b4b17~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>但如果我们 age 传一个浮点数，服务端也能正常接收：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f33b184c864e47a19257a94d41fe9b8f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bda66123b6494113ac2e12272e5f78f2~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>因为它也是 number。</p>
<p>而这很可能会导致后续的逻辑出错。</p>
<p>所以我们要对他做参数验证。</p>
<p>怎么做呢？</p>
<p>这就需要用到这节的 ValidationPipe 了。</p>
<p>它需要两个依赖包：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install <span class="hljs-keyword">class</span>-validator <span class="hljs-keyword">class</span>-transformer</span>
</code></pre>
<p>然后在 @Body 里添加这个 pipe：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85882d3e4a6e424e91c032bfbfc115c5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 dto 这里，用 class-validator 包的 @IsInt 装饰器标记一下：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d36bfb83ca2a4257b6f506aa3b735988~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>再次请求，你就会发现它检查出了参数里的错误：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dfb8e96a92eb454d8240f878e6ee3637~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>那它是怎么实现的呢？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fclass-validator" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/class-validator" ref="nofollow noopener noreferrer">class-validator</a> 包提供了基于装饰器声明的规则对对象做校验的功能：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e7b7376b04c458f9e92c863cef3456a~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fclass-transformer" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/class-transformer" ref="nofollow noopener noreferrer">class-transformer</a> 则是把一个普通对象转换为某个 class 的实例对象的：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/578fadf837754284a4952e45e322fd21~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b61c5f50c45b42eb87c7e9ad79704d64~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这两者一结合，那 ValidationPipe 是怎么实现的不就想明白了么：</p>
<p><strong>我们声明了参数的类型为 dto 类，pipe 里拿到这个类，把参数对象通过 class-transformer 转换为 dto 类的对象，之后再用 class-validator 包来对这个对象做验证。</strong></p>
<p>我们自己写写看：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PipeTransform</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">ArgumentMetadata</span>, <span class="hljs-title class_">BadRequestException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { validate } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { plainToInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-transformer'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">@<span class="hljs-title class_">Injectable</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyValidationPipe</span> implements <span class="hljs-title class_">PipeTransform</span>&lt;any&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">value: any, { metatype }: ArgumentMetadata</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-keyword">if</span> (!metatype) {</span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-keyword">return</span> value;</span>
<span class="code-block-extension-codeLine" data-line-num="10">    }</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-keyword">const</span> object = <span class="hljs-title function_">plainToInstance</span>(metatype, value);</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-keyword">const</span> errors = <span class="hljs-keyword">await</span> <span class="hljs-title function_">validate</span>(object);</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="hljs-keyword">if</span> (errors.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="14">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadRequestException</span>(<span class="hljs-string">'参数验证失败'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="15">    }</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-keyword">return</span> value;</span>
<span class="code-block-extension-codeLine" data-line-num="17">  }</span>
<span class="code-block-extension-codeLine" data-line-num="18">}</span>
</code></pre>
<p>pipe 里拿到的 metatype 就是这部分：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2d114db874a4949be4012eee67a21a0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>如果没有声明这部分，那就没法转换和验证，直接返回 value。</p>
<p>否则，通过 class-transformer 包的 plainToInstance 把普通对象转换为 dto class 的实例对象。</p>
<p>之后调用 class-validator 包的 validate api 对它做验证。如果验证不通过，就抛一个异常。</p>
<p>我们来用下看：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e74db89b6afa4d0ebdf966c630fa62b7~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>替换为我们自己实现的 MyValidationPipe。</p>
<p>再次请求下：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd4ec80f4d8744e89d0e3b81967575bd~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>确实检查出了错误。</p>
<p>当然，我们做的并不够完善，还是直接用内置的 ValidationPipe 好了。</p>
<p>pipe 里也是可以注入依赖的：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fc1687121fc474caf84258dc728cb59~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>比如，我们指定 @Inject 注入 token 为 validation_options 的对象。</p>
<p>因为标记了 @Optional，没找到对应的 provider 也不会报错：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e22faba38c894ef395105bf900e70a1e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>但当我们在 module 里添加了这个 provider：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/10128118e6a443649ceab27b41a18338~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>就可以正常注入了：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66ae19e0796f4ece8745eb08634c2687~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>当然，这种方式就不能用 new 的方式了：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e48818e0378a4a32a831e4b677ad1c2e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>直接指定 class，让 Nest 去创建对象放到 ioc 容器里。</p>
<p>如果是全局的 pipe，要通过这种方式来创建才能注入依赖：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d0bc8f8372d40edb3d86f5458e97686~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这就和我们之前创建全局 interceptor 一样。</p>
<p>同理，其余的 filter、guard 也可以通过这种方式声明为全局生效的：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b0073fb99ec44b1a56554eb7144d6dc~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>现在我们就可以把 handler 里的 ValidationPipe 去掉了</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f4e2c0a00084bc79776572aefd228ef~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>再次访问，它依然是生效的：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/017851a4b31e42db8aeab3de9b20bd93~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>当然，这里我们没有注入什么依赖，所以这种方式也可以：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ad509bf38ac42489e2702ef3ac99c29~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>会用 ValidationPipe 之后，我们回过头来再看看 class-validator 都支持哪些验证方式：</p>
<p>我们声明这样一个 dto class：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Contains</span>, <span class="hljs-title class_">IsDate</span>, <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsFQDN</span>, <span class="hljs-title class_">IsInt</span>, <span class="hljs-title class_">Length</span>, <span class="hljs-title class_">Max</span>, <span class="hljs-title class_">Min</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ppp</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    @<span class="hljs-title class_">Length</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">title</span>: string;</span>
<span class="code-block-extension-codeLine" data-line-num="6">  </span>
<span class="code-block-extension-codeLine" data-line-num="7">    @<span class="hljs-title class_">Contains</span>(<span class="hljs-string">'hello'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-attr">text</span>: string;</span>
<span class="code-block-extension-codeLine" data-line-num="9">  </span>
<span class="code-block-extension-codeLine" data-line-num="10">    @<span class="hljs-title class_">IsInt</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="11">    @<span class="hljs-title class_">Min</span>(<span class="hljs-number">0</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="12">    @<span class="hljs-title class_">Max</span>(<span class="hljs-number">10</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="hljs-attr">rating</span>: number;</span>
<span class="code-block-extension-codeLine" data-line-num="14">  </span>
<span class="code-block-extension-codeLine" data-line-num="15">    @<span class="hljs-title class_">IsEmail</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-attr">email</span>: string;</span>
<span class="code-block-extension-codeLine" data-line-num="17">  </span>
<span class="code-block-extension-codeLine" data-line-num="18">    @<span class="hljs-title class_">IsFQDN</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="19">    <span class="hljs-attr">site</span>: string;</span>
<span class="code-block-extension-codeLine" data-line-num="20">}</span>
</code></pre>
<p>其中 @IsFQDN 是是否是域名的意思。</p>
<p>然后添加一个 post 的 handler：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c48c65e0e869479b911c520d72f90368~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 postman 里发送 post 请求。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e82040862e514a42aed15255ee438ec3~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">json</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-json code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-punctuation">{</span></span>
<span class="code-block-extension-codeLine" data-line-num="2">    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"aaaaaaaaaaaaaaa"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hello aaa"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">"rating"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">"email"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"aaa@qq.com"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">"site"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"aaa.guang.com"</span><span class="hljs-punctuation">,</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">"createDate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-05-28T01:45:37.803Z"</span></span>
<span class="code-block-extension-codeLine" data-line-num="8"><span class="hljs-punctuation">}</span></span>
</code></pre>
<p>参数正确的时候是不会报错的。</p>
<p>当参数不正确，ValidationPipe 就会返回 class-validator 的报错：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/958ecb1dc38c4b4692bf9a6cc421b9bd~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>这个错误消息也是可以定制的：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e667a3fbc62485ab382767e5abea4b0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>添加一个 options 对象，传入 message 函数，打印下它的参数：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/932df50b7d144cb58b2862c07f33c41a~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="image.png" loading="lazy" class="medium-zoom-image"></p>
<p>可以拿到对象、属性名、属性值、class 名等各种信息，然后你可以返回自定义的 message：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">typescript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-typescript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-meta">@Length</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, {</span>
<span class="code-block-extension-codeLine" data-line-num="2">    <span class="hljs-title function_">message</span>(<span class="hljs-params">{targetName, property, value, constraints}</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${targetName}</span> 类的 <span class="hljs-subst">${property}</span> 属性的值 <span class="hljs-subst">${value}</span> 不满足约束: <span class="hljs-subst">${constraints}</span>`</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    }</span>
<span class="code-block-extension-codeLine" data-line-num="5">})</span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;</span>
</code></pre>
<p>再次访问，返回的就是自定义的错误消息：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/70705e328fb44fa8a4611a53d07a838d~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>更多的装饰器可以看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fclass-validator" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/class-validator" ref="nofollow noopener noreferrer">class-validator 文档</a>，这里就不展开了。</p>
<p>案例代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fnestjs-course-code%2Ftree%2Fmain%2Fpipe-test" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/pipe-test" ref="nofollow noopener noreferrer">小册仓库</a>。</p>
<h2 data-id="heading-0">总结</h2>
<p>接收 post 请求的方式是声明一个 dto class，然后通过 @Body 来取请求体来注入值。</p>
<p>对它做验证要使用 ValidationPipe。</p>
<p>它的实现原理是基于 class-tranformer 把参数对象转换为 dto class 的对象，然后通过 class-validator 基于装饰器对这个对象做验证。</p>
<p>我们可以自己实现这样的 pipe，pipe 里可以注入依赖。</p>
<p>如果是全局 pipe 想注入依赖，需要通过 APP_PIPE 的 token 在 AppModule 里声明 provider。</p>
<p>class-validator 支持很多种验证规则，比如邮箱、域名、长度、值的范围等，而且错误消息也可以自定义。</p>
<p>ValidationPipe 是非常常用的 pipe，后面会大量用到。</p></div>