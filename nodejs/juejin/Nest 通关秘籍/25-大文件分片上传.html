<header>
        <style>
            .markdown-body{
                width: 80%;
                margin: auto;
            }
            .code-block-extension-header{
                display: none;
            }
        </style>
    </header><div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>文件上传是常见需求，只要指定 content-type 为 multipart/form-data，内容就会以这种格式被传递到服务端：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3f2e069a81ba4d75a7c92f010adfe644~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1440&amp;h=836&amp;s=405486&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>服务端再按照 multipart/form-data 的格式提取数据，就能拿到其中的文件。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e06f7d7e18b04eb5812223cc20025027~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=460&amp;h=604&amp;s=24207&amp;e=png&amp;b=fefbfb" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>但当文件很大的时候，事情就变得不一样了。</p>
<p>假设传一个 100M 的文件需要 3 分钟，那传一个 1G 的文件就需要 30 分钟。</p>
<p>这样是能完成功能，但是产品的体验会很不好。</p>
<p>所以大文件上传的场景，需要做专门的优化。</p>
<p>把 1G 的大文件分割成 10 个 100M 的小文件，然后这些文件并行上传，不就快了？</p>
<p>然后等 10 个小文件都传完之后，再发一个请求把这 10 个小文件合并成原来的大文件。</p>
<p>这就是大文件分片上传的方案。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8b1015bdc6349238bb7a18b1b2c6095~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=606&amp;h=844&amp;s=53296&amp;e=png&amp;b=fefaf9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>那如何拆分和合并呢？</p>
<p>浏览器里 Blob 有 slice 方法，可以截取某个范围的数据，而 File 就是一种 Blob：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5a75a0f31cca4bf98954655488a1b8b0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1522&amp;h=686&amp;s=93393&amp;e=png&amp;b=f9f9f9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b339e52f61984a4dba01e75a5dcc370f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1524&amp;h=244&amp;s=63895&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>所以可以在 input 里选择了 file 之后，通过 slice 对 File 分片。</p>
<p>那合并呢？</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e2bce0816bb4e54ac46f363c600aab8~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1958&amp;h=1200&amp;s=271917&amp;e=png&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>fs 的 createWriteStream 方法支持指定 start，也就是从什么位置开始写入。</p>
<p>这样把每个分片按照不同位置写入文件里，不就完成合并了么。</p>
<p>思路理清了，接下来我们实现一下。</p>
<p>创建个 Nest 项目：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install -g @nestjs/cli</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">nest <span class="hljs-keyword">new</span> large-file-sharding-upload</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50562833c5cb4297998e3803536ab369~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1020&amp;h=688&amp;s=176132&amp;e=png&amp;b=010101" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 AppController 添加一个路由：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fad550c256f04e8bbca80d126271cbfe~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1318&amp;h=856&amp;s=192796&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Post</span>(<span class="hljs-string">'upload'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2">@<span class="hljs-title class_">UseInterceptors</span>(<span class="hljs-title class_">FilesInterceptor</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">20</span>, {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads'</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">}))</span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-title function_">uploadFiles</span>(<span class="hljs-params">@UploadedFiles() files: <span class="hljs-built_in">Array</span>&lt;Express.Multer.File&gt;, @Body() body</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'body'</span>, body);</span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'files'</span>, files);</span>
<span class="code-block-extension-codeLine" data-line-num="8">}</span>
</code></pre>
<p>这是一个 post 接口，会读取请求体里的 files 文件字段传入该方法。</p>
<p>这里还需要安装用到的 multer 包的类型：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">bash</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install -D @types/multer</span>
</code></pre>
<p>然后我们在网页里试一下：</p>
<p>首先在 main.ts 里开启跨域支持：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80387470962c48f0a0385c50da74dff4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=878&amp;h=402&amp;s=77339&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后添加一个 index.html：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/axios@0.24.0/dist/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="9"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="10"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">multiple</span>/&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></span></span>
<span class="code-block-extension-codeLine" data-line-num="13">        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#fileInput'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">        fileInput.<span class="hljs-property">onchange</span> =  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="16">            <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="17">            data.<span class="hljs-title function_">set</span>(<span class="hljs-string">'name'</span>,<span class="hljs-string">'光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="18">            data.<span class="hljs-title function_">set</span>(<span class="hljs-string">'age'</span>, <span class="hljs-number">20</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">            [...fileInput.<span class="hljs-property">files</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="21">                data.<span class="hljs-title function_">append</span>(<span class="hljs-string">'files'</span>, item)</span>
<span class="code-block-extension-codeLine" data-line-num="22">            })</span>
<span class="code-block-extension-codeLine" data-line-num="23"></span>
<span class="code-block-extension-codeLine" data-line-num="24">            <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'http://localhost:3000/upload'</span>, data);</span>
<span class="code-block-extension-codeLine" data-line-num="25">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);</span>
<span class="code-block-extension-codeLine" data-line-num="26">        }</span>
<span class="code-block-extension-codeLine" data-line-num="27">    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="28"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="29"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
</code></pre>
<p>input 指定 multiple，可以选择多个文件。</p>
<p>选择文件之后，通过 post 请求 upload 接口，携带 FormData。FormData 里保存着 files 和其它字段。</p>
<p>起个静态服务：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">vbscript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-vbscript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx http-<span class="hljs-built_in">server</span> .</span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/963cad3215e74adda04408c2e8b18e89~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=760&amp;h=614&amp;s=94942&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>浏览器访问下：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b4ad8f16478246868e4c5d6a5fb12f0c~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=700&amp;h=410&amp;s=26857&amp;e=png&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>选择几个文件：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/480c15d09dc044659723b175cb8d4fd0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1572&amp;h=1020&amp;s=1136212&amp;e=gif&amp;f=42&amp;b=fdfdfd" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这时候，Nest 服务端就接收到了上传的文件和其他字段：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2171fb3efe294ae384b5ba54ce40e051~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1730&amp;h=1232&amp;s=361371&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>当然，我们并不是想上传多个文件，而是一个大文件的多个分片。</p>
<p>所以是这样写：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">html</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-html code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/axios@0.24.0/dist/axios.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="9"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="10"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>/&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"></span></span>
<span class="code-block-extension-codeLine" data-line-num="13">        <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#fileInput'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">        <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">20</span> * <span class="hljs-number">1024</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">        fileInput.<span class="hljs-property">onchange</span> =  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="18"></span>
<span class="code-block-extension-codeLine" data-line-num="19">            <span class="hljs-keyword">const</span> file = fileInput.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];</span>
<span class="code-block-extension-codeLine" data-line-num="20"></span>
<span class="code-block-extension-codeLine" data-line-num="21">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(file);</span>
<span class="code-block-extension-codeLine" data-line-num="22"></span>
<span class="code-block-extension-codeLine" data-line-num="23">            <span class="hljs-keyword">const</span> chunks = [];</span>
<span class="code-block-extension-codeLine" data-line-num="24">            <span class="hljs-keyword">let</span> startPos = <span class="hljs-number">0</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="25">            <span class="hljs-keyword">while</span>(startPos &lt; file.<span class="hljs-property">size</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="26">                chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(startPos, startPos + chunkSize));</span>
<span class="code-block-extension-codeLine" data-line-num="27">                startPos += chunkSize;</span>
<span class="code-block-extension-codeLine" data-line-num="28">            }</span>
<span class="code-block-extension-codeLine" data-line-num="29"></span>
<span class="code-block-extension-codeLine" data-line-num="30">            chunks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunk, index</span>) =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="31">                <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="32">                data.<span class="hljs-title function_">set</span>(<span class="hljs-string">'name'</span>, file.<span class="hljs-property">name</span> + <span class="hljs-string">'-'</span> + index)</span>
<span class="code-block-extension-codeLine" data-line-num="33">                data.<span class="hljs-title function_">append</span>(<span class="hljs-string">'files'</span>, chunk);</span>
<span class="code-block-extension-codeLine" data-line-num="34">                axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'http://localhost:3000/upload'</span>, data);</span>
<span class="code-block-extension-codeLine" data-line-num="35">            })</span>
<span class="code-block-extension-codeLine" data-line-num="36">        </span>
<span class="code-block-extension-codeLine" data-line-num="37">        }</span>
<span class="code-block-extension-codeLine" data-line-num="38"></span>
<span class="code-block-extension-codeLine" data-line-num="39">    <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="40"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
<span class="code-block-extension-codeLine" data-line-num="41"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
</code></pre>
<p>对拿到的文件进行分片，然后单独上传每个分片，分片名字为文件名 + index。</p>
<p>这里我们测试用的图片是 80k：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68fbe48d17cc428497d0483a1405a79e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=846&amp;h=564&amp;s=204232&amp;e=png&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>所以每 20k 一个分片，一共是 4 个分片。</p>
<p>测试下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43d077a6f685449b9cf5087d3629c3ce~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1606&amp;h=1102&amp;s=1031020&amp;e=gif&amp;f=31&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>服务端接收到了这 4 个分片:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/096df6ae3eeb4508bc83867423fb33a0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1306&amp;h=1346&amp;s=315887&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后我们把它们移动到单独的目录：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Post</span>(<span class="hljs-string">'upload'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2">@<span class="hljs-title class_">UseInterceptors</span>(<span class="hljs-title class_">FilesInterceptor</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">20</span>, {</span>
<span class="code-block-extension-codeLine" data-line-num="3">  <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads'</span></span>
<span class="code-block-extension-codeLine" data-line-num="4">}))</span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-title function_">uploadFiles</span>(<span class="hljs-params">@UploadedFiles() files: <span class="hljs-built_in">Array</span>&lt;Express.Multer.File&gt;, @Body() body: { name: string }</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="6">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'body'</span>, body);</span>
<span class="code-block-extension-codeLine" data-line-num="7">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'files'</span>, files);</span>
<span class="code-block-extension-codeLine" data-line-num="8"></span>
<span class="code-block-extension-codeLine" data-line-num="9">  <span class="hljs-keyword">const</span> fileName = body.<span class="hljs-property">name</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(.+)\-\d+$/</span>)[<span class="hljs-number">1</span>];</span>
<span class="code-block-extension-codeLine" data-line-num="10">  <span class="hljs-keyword">const</span> chunkDir = <span class="hljs-string">'uploads/chunks_'</span>+ fileName;</span>
<span class="code-block-extension-codeLine" data-line-num="11"></span>
<span class="code-block-extension-codeLine" data-line-num="12">  <span class="hljs-keyword">if</span>(!fs.<span class="hljs-title function_">existsSync</span>(chunkDir)){</span>
<span class="code-block-extension-codeLine" data-line-num="13">    fs.<span class="hljs-title function_">mkdirSync</span>(chunkDir);</span>
<span class="code-block-extension-codeLine" data-line-num="14">  }</span>
<span class="code-block-extension-codeLine" data-line-num="15">  fs.<span class="hljs-title function_">cpSync</span>(files[<span class="hljs-number">0</span>].<span class="hljs-property">path</span>, chunkDir + <span class="hljs-string">'/'</span> + body.<span class="hljs-property">name</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="16">  fs.<span class="hljs-title function_">rmSync</span>(files[<span class="hljs-number">0</span>].<span class="hljs-property">path</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>
<p>用正则匹配出文件名：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09835fc0320b4edd9985e61a19ef5b94~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=530&amp;h=100&amp;s=18743&amp;e=png&amp;b=fefdfd" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 uploads 下创建 chunks_文件名 的目录，把文件复制过去，然后删掉原始文件。</p>
<p>测试下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43d077a6f685449b9cf5087d3629c3ce~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1606&amp;h=1102&amp;s=1031020&amp;e=gif&amp;f=31&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a69d360cd314fa6becb5ad96488f266~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1512&amp;h=1198&amp;s=276105&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>分片文件移动成功了。</p>
<p>不过直接以 chunks_文件名 做为目录名，太容易冲突了。</p>
<p>我们可以在上传文件的时候给文件名加一个随机的字符串。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcd76b0568f54cf09d779b819fbd220c~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1044&amp;h=900&amp;s=176091&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这样就不会冲突了：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d0870734f674c8990672228814432e7~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=486&amp;h=416&amp;s=40728&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>接下来，就是在全部分片上传完之后，发送合并分片的请求。</p>
<p>添加一个 merge 的接口：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Get</span>(<span class="hljs-string">'merge'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-title function_">merge</span>(<span class="hljs-params">@Query(<span class="hljs-string">'name'</span>) name: string</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-keyword">const</span> chunkDir = <span class="hljs-string">'uploads/chunks_'</span>+ name;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(chunkDir);</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-keyword">let</span> startPos = <span class="hljs-number">0</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="8">    files.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="9">      <span class="hljs-keyword">const</span> filePath = chunkDir + <span class="hljs-string">'/'</span> + file;</span>
<span class="code-block-extension-codeLine" data-line-num="10">      <span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(filePath);</span>
<span class="code-block-extension-codeLine" data-line-num="11">      stream.<span class="hljs-title function_">pipe</span>(fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">'uploads/'</span> + name, {</span>
<span class="code-block-extension-codeLine" data-line-num="12">        <span class="hljs-attr">start</span>: startPos</span>
<span class="code-block-extension-codeLine" data-line-num="13">      }))</span>
<span class="code-block-extension-codeLine" data-line-num="14"></span>
<span class="code-block-extension-codeLine" data-line-num="15">      startPos += fs.<span class="hljs-title function_">statSync</span>(filePath).<span class="hljs-property">size</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="16">    })</span>
<span class="code-block-extension-codeLine" data-line-num="17">}</span>
</code></pre>
<p>接收文件名，然后查找对应的 chunks 目录，把下面的文件读取出来，按照不同的 start 位置写入到同一个文件里。</p>
<p>浏览器访问下这个接口：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3105597f454d4cf1baff08949c6016ce~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=804&amp;h=220&amp;s=19364&amp;e=png&amp;b=ffffff" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>可以看到，合并成功了：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ebc3c0c4a2143cf9a37676f40937415~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1816&amp;h=1050&amp;s=450395&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>再测试一个：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/847eb844a2204e08888d084cdb18bff8~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=898&amp;h=284&amp;s=23027&amp;e=png&amp;b=ffffff" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd9e36416e4f4b86ba54303de9936964~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1838&amp;h=1054&amp;s=487249&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>也没啥问题。</p>
<p>然后我们在合并完成之后把 chunks 目录删掉。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/741d40da15414716b4cb07f15390e025~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=814&amp;h=786&amp;s=122018&amp;e=png&amp;b=202020" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Get</span>(<span class="hljs-string">'merge'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-title function_">merge</span>(<span class="hljs-params">@Query(<span class="hljs-string">'name'</span>) name: string</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-keyword">const</span> chunkDir = <span class="hljs-string">'uploads/chunks_'</span>+ name;</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-keyword">const</span> files = fs.<span class="hljs-title function_">readdirSync</span>(chunkDir);</span>
<span class="code-block-extension-codeLine" data-line-num="6"></span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-keyword">let</span> startPos = <span class="hljs-number">0</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="9">    files.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="10">      <span class="hljs-keyword">const</span> filePath = chunkDir + <span class="hljs-string">'/'</span> + file;</span>
<span class="code-block-extension-codeLine" data-line-num="11">      <span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(filePath);</span>
<span class="code-block-extension-codeLine" data-line-num="12">      stream.<span class="hljs-title function_">pipe</span>(fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">'uploads/'</span> + name, {</span>
<span class="code-block-extension-codeLine" data-line-num="13">        <span class="hljs-attr">start</span>: startPos</span>
<span class="code-block-extension-codeLine" data-line-num="14">      })).<span class="hljs-title function_">on</span>(<span class="hljs-string">'finish'</span>, <span class="hljs-function">() =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="15">        count ++;</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">        <span class="hljs-keyword">if</span>(count === files.<span class="hljs-property">length</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="18">          fs.<span class="hljs-title function_">rm</span>(chunkDir, {</span>
<span class="code-block-extension-codeLine" data-line-num="19">            <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span></span>
<span class="code-block-extension-codeLine" data-line-num="20">          }, <span class="hljs-function">() =&gt;</span>{});</span>
<span class="code-block-extension-codeLine" data-line-num="21">        }</span>
<span class="code-block-extension-codeLine" data-line-num="22">      })</span>
<span class="code-block-extension-codeLine" data-line-num="23"></span>
<span class="code-block-extension-codeLine" data-line-num="24">      startPos += fs.<span class="hljs-title function_">statSync</span>(filePath).<span class="hljs-property">size</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="25">    });</span>
<span class="code-block-extension-codeLine" data-line-num="26">}</span>
</code></pre>
<p>然后在前端代码里，当分片全部上传完之后，调用 merge 接口：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5da3ccb6b0bc4b40bc724560618895ca~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1176&amp;h=918&amp;s=200174&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">const</span> tasks = [];</span>
<span class="code-block-extension-codeLine" data-line-num="2">chunks.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">chunk, index</span>) =&gt;</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">    data.<span class="hljs-title function_">set</span>(<span class="hljs-string">'name'</span>, randomStr + <span class="hljs-string">'_'</span> + file.<span class="hljs-property">name</span> + <span class="hljs-string">'-'</span> + index)</span>
<span class="code-block-extension-codeLine" data-line-num="6">    data.<span class="hljs-title function_">append</span>(<span class="hljs-string">'files'</span>, chunk);</span>
<span class="code-block-extension-codeLine" data-line-num="7">    tasks.<span class="hljs-title function_">push</span>(axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'http://localhost:3000/upload'</span>, data));</span>
<span class="code-block-extension-codeLine" data-line-num="8">})</span>
<span class="code-block-extension-codeLine" data-line-num="9"><span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);</span>
<span class="code-block-extension-codeLine" data-line-num="10">axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://localhost:3000/merge?name='</span> + randomStr + <span class="hljs-string">'_'</span> + file.<span class="hljs-property">name</span>);</span>
</code></pre>
<p>连起来测试下：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faeb926af8e34efeb7001d020fd6d447~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1802&amp;h=1172&amp;s=2346315&amp;e=gif&amp;f=70&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>因为文件比较小，开启 network 的 slow 3g 网速来测。</p>
<p>可以看到，分片上传和最后的合并都没问题。</p>
<p>当然，你还可以加一个进度条，这个用 axios 很容易实现：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d535852ecbb24d72bbbf68fec7980269~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1166&amp;h=648&amp;s=114159&amp;e=png&amp;b=f7f7f7" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>至此，大文件分片上传就完成了。</p>
<p>案例代码上传里 github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fnestjs-course-code%2Ftree%2Fmain%2Flarge-file-sharding-upload" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/large-file-sharding-upload" ref="nofollow noopener noreferrer">github.com/QuarkGluonP…</a></p>
<h2 data-id="heading-0">总结</h2>
<p>当文件比较大的时候，文件上传会很慢，这时候一般我们会通过分片的方式来优化。</p>
<p>原理就是浏览器里通过 slice 来把文件分成多个分片，并发上传。</p>
<p>服务端把这些分片文件保存在一个目录下。</p>
<p>当所有分片传输完成时，发送一个合并请求，服务端通过 fs.createWriteStream 指定 start 位置，来把这些分片文件写入到同一个文件里，完成合并。</p>
<p>这样，我们就实现了大文件分片上传。</p></div>