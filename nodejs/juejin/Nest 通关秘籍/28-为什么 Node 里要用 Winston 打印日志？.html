<header>
        <style>
            .markdown-body{
                width: 80%;
                margin: auto;
            }
            .code-block-extension-header{
                display: none;
            }
        </style>
    </header><div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Node 里怎么打印日志呢？</p>
<p>有同学说，不也是用 console.log 么。</p>
<p>不，服务端打印日志一般不会用 console.log。</p>
<p>因为 console.log 打印完就没了，而服务端的日志经常要用来排查问题，需要搜索、分析日志内容，所以需要写入文件或者数据库里。</p>
<p>而且打印的日志需要分级别，比如有的是错误的日志，有的只是普通日志，需要能够过滤不同级别的日志。</p>
<p>此外，打印的日志需要带上时间戳，所在的代码位置等信息。</p>
<p>这些都是 console.log 没有的功能。</p>
<p>所以我们一般都会用专门的日志框架来做，比如 winston。</p>
<p>它是 Node 最流行的日志框架，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fwinston" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/winston" ref="nofollow noopener noreferrer">npm 官网</a>上可以看到每周千万级的下载量：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a0d65f5b90548bfaa4c5ac12a888697~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=556&amp;h=604&amp;s=47935&amp;e=png&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>那 winston 都有什么功能？怎么用呢？</p>
<p>我们试试看：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">bash</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-built_in">mkdir</span> winston-test</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-built_in">cd</span> winston-test</span>
<span class="code-block-extension-codeLine" data-line-num="3">npm init -y</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/642f73bedb39404aaebab2522cd2f7fe~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=812&amp;h=686&amp;s=127944&amp;e=png&amp;b=000000" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>先创建个项目。</p>
<p>安装 winston：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install <span class="hljs-attr">--save</span> winston</span>
</code></pre>
<p>然后写下 index.js</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="7">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="8">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({ </span>
<span class="code-block-extension-codeLine" data-line-num="9">            <span class="hljs-attr">dirname</span>: <span class="hljs-string">'log'</span>, <span class="hljs-attr">filename</span>: <span class="hljs-string">'test.log'</span> </span>
<span class="code-block-extension-codeLine" data-line-num="10">        }),</span>
<span class="code-block-extension-codeLine" data-line-num="11">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="12">});</span>
<span class="code-block-extension-codeLine" data-line-num="13"></span>
<span class="code-block-extension-codeLine" data-line-num="14">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="15">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="16">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>用 createLogger 创建了 logger 实例，指定 level、format、tranports。</p>
<p>level：打印的日志级别</p>
<p>format：日志格式</p>
<p>transports：日志的传输方式</p>
<p>我们指定了 Console 和 File 两种传输方式。</p>
<p>在 package.json 里指定 type 为 module，也就是所有代码都是 es module 的：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6e342e670838498b8f1b1a42dc913bed~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=530&amp;h=402&amp;s=55987&amp;e=png&amp;b=202020" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这样代码里就可以直接用 import、export 这些语法了。</p>
<p>用 node 跑一下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang"></span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">node index.js</span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5ea61bd0d0cf45e6b0f31ade40551308~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1210&amp;h=564&amp;s=88217&amp;e=png&amp;b=1b1b1b" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>可以看到控制台和文件里都有了打印的日志。</p>
<p>再跑一遍：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang"></span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">node index.js</span>
</code></pre>
<p>会在后面追加：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/527f2f4f626948e6bc30fb40e6ae038c~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=908&amp;h=338&amp;s=56832&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>那么问题来了，如果所有日志都写在一个文件里，那这个文件最终会不会特别大？</p>
<p>不用担心，winston 支持按照大小自动分割文件：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4f8daa3082c4ff3a323e2a9c60ecef1~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1114&amp;h=642&amp;s=119756&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>我们指定 maxsize 为 1024 字节，也就是 1kb。</p>
<p>然后再跑几次：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b0e054204ef45438c81d714c76c0515~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1132&amp;h=1148&amp;s=223224&amp;e=png&amp;b=1a1a1a" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>大概跑了 10 次左右，出现了第二个文件：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3d388d3363547be863123c531bdba92~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=910&amp;h=332&amp;s=59599&amp;e=png&amp;b=1e1e1e" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>而这时第一个日志文件刚好是 1kb：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ec72c1f41154446827eaa063bd5435e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=926&amp;h=596&amp;s=67453&amp;e=png&amp;b=fefefe" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这就是根据大小自动分割日志文件的功能。</p>
<p>有同学说，一般日志都是按照日期自动分割的，比如 2023-10-28 的日志文件，2023-10-29 的日志文件，这样之后也好管理。</p>
<p>这个支持么？</p>
<p>当然支持，但是要换别的 Transport 了。</p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwinstonjs%2Fwinston%2Fblob%2FHEAD%2Fdocs%2Ftransports.md%23winston-core" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/winstonjs/winston/blob/HEAD/docs/transports.md#winston-core" ref="nofollow noopener noreferrer">winston 文档</a>里可以看到有很多 Transport：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea5db55345e24f0bb77ddc3c37d37ba3~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=864&amp;h=1016&amp;s=106987&amp;e=png&amp;b=ffffff" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>Console、File、Http、Stream 这几个 Transport 是内置的。</p>
<p>下面还有很多社区的 Transport，比如 MongoDB 的 Transport，很明显就是把日志写入 mongodb 的。</p>
<p>这里的 DailyRotateFile 就是按照日期滚动存储到日志文件的 Transport。</p>
<p>我们试试看：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">css</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-css code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install <span class="hljs-attr">--save</span> winston-daily-rotate-file</span>
</code></pre>
<p>安装这个 Transport。</p>
<p>然后改下代码：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="8">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="9">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">DailyRotateFile</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="10">            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="11">            <span class="hljs-attr">dirname</span>: <span class="hljs-string">'log2'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="12">            <span class="hljs-attr">filename</span>: <span class="hljs-string">'test-%DATE%.log'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="13">            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD-HH-mm'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="14">            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'1k'</span></span>
<span class="code-block-extension-codeLine" data-line-num="15">        })</span>
<span class="code-block-extension-codeLine" data-line-num="16">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="17">});</span>
<span class="code-block-extension-codeLine" data-line-num="18"></span>
<span class="code-block-extension-codeLine" data-line-num="19">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="20">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="21">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>这里使用了 DailyRotateFile 的 transport，然后指定了文件名和日期格式。</p>
<p>指定文件名里的日志格式包含分钟，所以不同的分钟打印的日志会写入不同文件里：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33f0cb082f31458e988525910787d0fb~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1182&amp;h=322&amp;s=62610&amp;e=png&amp;b=1e1e1e" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这就达到了滚动日志的效果。</p>
<p>再来试试 http 的 transport：</p>
<p>先创建个 nest 服务：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">vbscript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-vbscript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">nest <span class="hljs-keyword">new</span> winston-log-<span class="hljs-built_in">server</span></span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d82b3a3bc694cdebed44d65a4a6dcdd~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=942&amp;h=674&amp;s=284602&amp;e=png&amp;b=010101" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>添加一个路由：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9627e64fdb34e36a2bc0ae411bbb06b~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=814&amp;h=666&amp;s=117492&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Post</span>(<span class="hljs-string">'log'</span>)</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-title function_">log</span>(<span class="hljs-params">@Body() body</span>) {</span>
<span class="code-block-extension-codeLine" data-line-num="3">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(body);</span>
<span class="code-block-extension-codeLine" data-line-num="4">}</span>
</code></pre>
<p>把它跑起来：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm run start:dev</span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a877b312c1e84825b8ab687f52a80866~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1228&amp;h=366&amp;s=122431&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后改下 index.js</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="3"></span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="8">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="9">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Http</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="10">            <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="11">            <span class="hljs-attr">port</span>: <span class="hljs-string">'3000'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="12">            <span class="hljs-attr">path</span>: <span class="hljs-string">'/log'</span></span>
<span class="code-block-extension-codeLine" data-line-num="13">        })</span>
<span class="code-block-extension-codeLine" data-line-num="14">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="15">});</span>
<span class="code-block-extension-codeLine" data-line-num="16"></span>
<span class="code-block-extension-codeLine" data-line-num="17">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="18">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="19">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>使用 http 的 transport 来传输日志。</p>
<p>跑一下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">bash</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">node ./index.js</span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e78108e221b74dcf81e7551f990e49b4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=542&amp;h=164&amp;s=23391&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b39035003c343b7a6d31e89a3a6576c~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=830&amp;h=512&amp;s=111820&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>nest 服务收到了传过来的日志。</p>
<p>基本上，内置的和社区的 transport 就足够用了，不管是想把日志发送到别的服务，还是把日志存到数据库等，都可以用不同 Transport 实现。</p>
<p>这些 transport 可以用 add、remove 方法来动态增删：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> <span class="hljs-variable language_">console</span> = <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="4"><span class="hljs-keyword">const</span> file = <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({ <span class="hljs-attr">filename</span>: <span class="hljs-string">'test.log'</span> });</span>
<span class="code-block-extension-codeLine" data-line-num="5"></span>
<span class="code-block-extension-codeLine" data-line-num="6"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="9">});</span>
<span class="code-block-extension-codeLine" data-line-num="10"></span>
<span class="code-block-extension-codeLine" data-line-num="11">logger.<span class="hljs-title function_">clear</span>();</span>
<span class="code-block-extension-codeLine" data-line-num="12">logger.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">console</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="13">logger.<span class="hljs-title function_">remove</span>(<span class="hljs-variable language_">console</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="14">logger.<span class="hljs-title function_">add</span>(file);</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="17">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="18">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>比如我先 clear，然后动态添加又删除了 console，然后又添加了一个 file 的 transport。</p>
<p>效果就是只有一个 file 的 transport：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e4a9ad955fb498182bda9231b0dd581~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1082&amp;h=684&amp;s=92309&amp;e=png&amp;b=1c1c1c" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>再就是日志级别，winston 有 6 种级别的日志：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5577d07cbe21459f9b4fffcba5443e7b~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=472&amp;h=486&amp;s=30770&amp;e=png&amp;b=f7f7f7" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>从上往下，重要程度依次降低。</p>
<p>比如当你指定 level 是 info 时，那 info、warn、error 的日志会输出，而 http、debug 这些不会。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/65d7eba57be74bb4a295117aa74a0b89~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=826&amp;h=608&amp;s=91608&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38f5993e89a44ae08d6d38512d7a62f4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=858&amp;h=702&amp;s=105645&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>日志级别的功能虽然简单，但却是很实用的功能。</p>
<p>日志可以通过 format 指定格式：</p>
<p>simple：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8399f03b559e4d35ab022d17bec48d48~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=786&amp;h=744&amp;s=114721&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>json：
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1a86f51a19b4aedb73ca853a4d49b7d~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=794&amp;h=718&amp;s=120569&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>prettyPrint（比 json 的格式多了一些空格）：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eff507e4696e453eaa6f10d272bf2bc4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=896&amp;h=792&amp;s=131623&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>用 combine 组合 timestamp 和 json：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9740fb3f13414789884fb2d615676d25~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1296&amp;h=742&amp;s=149315&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>或者再组合个 label：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f453f0e45de044509a7de965edefdd15~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1488&amp;h=626&amp;s=142403&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>加上个标签，再搜索相关日志就方便多了。</p>
<p>彩色：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61e3762babce4aa681dc2d132b825ee5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=834&amp;h=698&amp;s=113226&amp;e=png&amp;b=1d1d1d" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>通过这些，就可以指定各种日志格式。</p>
<p>但现在有个问题，如果我不同的 transport 要指定不同的格式呢？</p>
<p>可以这样：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="6">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="7">            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="8">                winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="9">                winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="10">            ),</span>
<span class="code-block-extension-codeLine" data-line-num="11">        }),</span>
<span class="code-block-extension-codeLine" data-line-num="12">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({ </span>
<span class="code-block-extension-codeLine" data-line-num="13">            <span class="hljs-attr">dirname</span>: <span class="hljs-string">'log3'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="14">            <span class="hljs-attr">filename</span>: <span class="hljs-string">'test.log'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="15">            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">json</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="16">        }),</span>
<span class="code-block-extension-codeLine" data-line-num="17">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="18">});</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="21">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="22">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>每个 transport 单独指定 format 就好了。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ba9e0e9c4ac47a5a1563c3bc2e6dce1~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=514&amp;h=160&amp;s=22739&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50cea20a3307415c8ba1369094ead62b~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1190&amp;h=210&amp;s=50227&amp;e=png&amp;b=1e1e1e" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>那如果我有的日志只想 console，而有的日志希望写入文件，而且配置都不同呢？</p>
<p>我们可以创建多个 logger 实例，每个 logger 实例有不同的 format、transport、level 等配置：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3">winston.<span class="hljs-property">loggers</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'console'</span>, {</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="5">        winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="6">        winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="7">    ),</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="9">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="10">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="11">});</span>
<span class="code-block-extension-codeLine" data-line-num="12"></span>
<span class="code-block-extension-codeLine" data-line-num="13">winston.<span class="hljs-property">loggers</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'file'</span>, {</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="hljs-attr">format</span>:winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(</span>
<span class="code-block-extension-codeLine" data-line-num="15">        winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">timestamp</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="16">        winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">json</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="17">    ),</span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="19">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="20">            <span class="hljs-attr">dirname</span>: <span class="hljs-string">'log4'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="21">            <span class="hljs-attr">filename</span>: <span class="hljs-string">'test.log'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="22">            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">json</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="23">        })</span>
<span class="code-block-extension-codeLine" data-line-num="24">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="25">});</span>
<span class="code-block-extension-codeLine" data-line-num="26"></span>
<span class="code-block-extension-codeLine" data-line-num="27"></span>
<span class="code-block-extension-codeLine" data-line-num="28"><span class="hljs-keyword">const</span> logger1 = winston.<span class="hljs-property">loggers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'console'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="29"></span>
<span class="code-block-extension-codeLine" data-line-num="30">logger1.<span class="hljs-title function_">info</span>(<span class="hljs-string">'aaaaa'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="31">logger1.<span class="hljs-title function_">error</span>(<span class="hljs-string">'bbbbb'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="32"></span>
<span class="code-block-extension-codeLine" data-line-num="33"><span class="hljs-keyword">const</span> logger2 = winston.<span class="hljs-property">loggers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'file'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="34"></span>
<span class="code-block-extension-codeLine" data-line-num="35">logger2.<span class="hljs-title function_">info</span>(<span class="hljs-string">'xxxx'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="36">logger2.<span class="hljs-title function_">info</span>(<span class="hljs-string">'yyyy'</span>);</span>
</code></pre>
<p>我们创建了 2 个 logger 实例，其中一个只写入 console，另一个只写入 file，并且 format 都不同。</p>
<p>然后分别用不同的 logger 来打印日志。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee8252d81b5b4d6fbacdaa32eded9861~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=386&amp;h=148&amp;s=18845&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb3fa4aba52e4e54bb7059e8317c89cb~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1228&amp;h=214&amp;s=45557&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这样，项目中有不同的日志需求的时候，就可以创建多个 logger 实例。</p>
<p>此外，winston 还支持指定如何处理未捕获的错误的日志：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="7">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="8">    ],</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-attr">exceptionHandlers</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="10">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="11">            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error.log'</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">        })</span>
<span class="code-block-extension-codeLine" data-line-num="13">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="14">});</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16"><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'xxx'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="17"></span>
<span class="code-block-extension-codeLine" data-line-num="18">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="19">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="20">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p>跑一下，可以看到错误日志被输出到了 error.log</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05be437a9ab24732a2c04d0b57e8bd5d~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1224&amp;h=246&amp;s=52553&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>除了 error 外，Promise 的未捕获异常也可以指定如何处理日志：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> winston <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">const</span> logger = winston.<span class="hljs-title function_">createLogger</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="4">    <span class="hljs-attr">level</span>: <span class="hljs-string">'debug'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="5">    <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">simple</span>(),</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">transports</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="7">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="8">    ],</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-attr">rejectionHandlers</span>: [</span>
<span class="code-block-extension-codeLine" data-line-num="10">        <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">File</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="11">            <span class="hljs-attr">filename</span>: <span class="hljs-string">'rejection.log'</span></span>
<span class="code-block-extension-codeLine" data-line-num="12">        })</span>
<span class="code-block-extension-codeLine" data-line-num="13">    ]</span>
<span class="code-block-extension-codeLine" data-line-num="14">});</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16">(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){</span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'yyy'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="18">})();</span>
<span class="code-block-extension-codeLine" data-line-num="19"></span>
<span class="code-block-extension-codeLine" data-line-num="20">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'光光光光光光光光光'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="21">logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'东东东东东东东东'</span>);</span>
<span class="code-block-extension-codeLine" data-line-num="22">logger.<span class="hljs-title function_">debug</span>(<span class="hljs-number">66666666</span>);</span>
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50ec5aff43824a1ba3df19fefa42aca6~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1238&amp;h=268&amp;s=66666&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这些就是 winston 的主要功能了。</p>
<p>案例代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fnestjs-course-code%2Ftree%2Fmain%2Fwinston-test" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/winston-test" ref="nofollow noopener noreferrer">小册仓库</a>。</p>
<h2 data-id="heading-0">总结</h2>
<p>Node 服务端我们不会用 console.log 打印日志，而是会用日志框架，比如 winston。</p>
<p>winston 支持 tranport 配置，可以把日志传输到 console、file、通过 http 发送到别的服务，写入 mongodb 数据库等。</p>
<p>社区有很多 transport 可用，我们尝试了滚动日志的 transport，可以根据日期来自动分割日志文件。</p>
<p>winston 还支持 level 配置，可以根据级别来过滤日志。</p>
<p>而且还支持 format 的设置，比如 json、simple、label、timstamp 等，一般我们输出到文件里的都是 json 格式，并且给他加上时间戳和 label，这样方便之后分析。</p>
<p>每个 transport 都可以单独指定 format，而且还可以创建多个 logger，每个 logger 用不同的配置。</p>
<p>此外，winston 还支持指定未捕获的 error 的日志怎么处理。</p>
<p>总之，相比直接 console.log，用 winston 这样的灵活强大的日志框架可太香了。</p></div>