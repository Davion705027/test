<header>
        <style>
            .markdown-body{
                width: 80%;
                margin: auto;
            }
            .code-block-extension-header{
                display: none;
            }
        </style>
    </header><div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre>code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前面我们基于 TypeORM 操作数据库都是开启了 synchronize，只要创建或者修改了 Entity，那就会自动创建表和修改表结构。</p>
<p>在开发时这样很方便，只要关注代码就好了，不用管修改表结构的事情。</p>
<p>但是在生产环境下，用 synchronize 很危险，很容易丢数据。</p>
<p>我们试一下：</p>
<p>新建一个 TypeORM 项目：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">shell</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-shell code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm@latest init --name typeorm-migration --database mysql</span>
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bd55f80d3f94d628c951bc6fe56a356~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1268&amp;h=160&amp;s=61319&amp;e=png&amp;b=000000" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>改下 data-source.ts 的配置：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">typescript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-typescript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> <span class="hljs-string">"reflect-metadata"</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"typeorm"</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./entity/User"</span></span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">type</span>: <span class="hljs-string">"mysql"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">host</span>: <span class="hljs-string">"localhost"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-attr">username</span>: <span class="hljs-string">"root"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="hljs-attr">password</span>: <span class="hljs-string">"guang"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-attr">database</span>: <span class="hljs-string">"migration-test"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">true</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="hljs-attr">logging</span>: <span class="hljs-literal">true</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="hljs-attr">entities</span>: [<span class="hljs-title class_">User</span>],</span>
<span class="code-block-extension-codeLine" data-line-num="15">    <span class="hljs-attr">migrations</span>: [],</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-attr">subscribers</span>: [],</span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-attr">poolSize</span>: <span class="hljs-number">10</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-attr">connectorPackage</span>: <span class="hljs-string">'mysql2'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="19">    <span class="hljs-attr">extra</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="20">        <span class="hljs-attr">authPlugin</span>: <span class="hljs-string">'sha256_password'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="21">    }</span>
<span class="code-block-extension-codeLine" data-line-num="22">})</span>
<span class="code-block-extension-codeLine" data-line-num="23"></span>
</code></pre>
<p>安装用到的 mysql2:</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">shell</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-shell code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm install --save mysql2</span>
</code></pre>
<p>在 mysql workbench 里创建这个 database：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5907f0ad5f04a89826213687a3c5693~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1534&amp;h=1136&amp;s=274049&amp;e=png&amp;b=e7e5e5" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>指定名字和字符集，点击 apply.</p>
<p>或者也可以执行这个 sql 来创建：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">sql</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-sql code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">CREATE</span> SCHEMA `migration<span class="hljs-operator">-</span>test` <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 ;</span>
</code></pre>
<p>跑一下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm run start</span>
</code></pre>
<p>可以看到，会自动创建 Entity 对应的表：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/afe862ae970649efb7b968a72b15e006~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1314&amp;h=884&amp;s=206847&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 mysql workbench 里也可以看到这个表：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7a0540ead1a40bdabcfeab85f0e23e6~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1158&amp;h=662&amp;s=229379&amp;e=png&amp;b=f0eceb" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>把插入数据的代码注释掉：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67cf55eccb264f0c9cca726db3b8678c~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1242&amp;h=814&amp;s=170883&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>改下 Entity：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00d955f21b824acd907ecae731d4d210~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=824&amp;h=714&amp;s=83490&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>重新跑下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npm run start</span>
</code></pre>
<p>可以看到 TypeORM 检测到 Entity 的变更，修改了表结构：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff7b09363e5a4945bd0f64bf39897d8e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=856&amp;h=710&amp;s=92513&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 mysql workbench 里可以看到，之前的 age 列就没了：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16cf5ea62185424881f61cc7706c60d9~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1048&amp;h=564&amp;s=187440&amp;e=png&amp;b=efecea" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>数据是不是就全丢了！</p>
<p>更何况跑 nest 项目的时候都是用 npm run start:dev，代码改动立刻重新跑，所以很容易丢数据。</p>
<p>所以说，synchronize 在开发环境下确实很方便，但是在生产环境下不能用，不安全。</p>
<p>那不用 synchonize 用啥呢，手动去数据库执行 sql 么？</p>
<p>那倒也不用。</p>
<p>可以用 TypeORM 的 migration 功能。</p>
<p>migration 是迁移的意思，其实前面的 create table、alter table 这些都是 migration：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/afe862ae970649efb7b968a72b15e006~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1314&amp;h=884&amp;s=206847&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff7b09363e5a4945bd0f64bf39897d8e~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=856&amp;h=710&amp;s=92513&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>只不过之前是自动跑，而现在我们要管理起来，手动跑。</p>
<p>把 package.json 里的 type 改为 module，也就是指定 node 跑的是 es module 的：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee065f42ac404c84b47a15fff3b7ff2b~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=638&amp;h=326&amp;s=53011&amp;e=png&amp;b=202020" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后执行 migration:create 的命令：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">shell</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-shell code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:create ./src/migration/Aaa</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ebf9261e46e41a9a51cf3e3f681d222~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1592&amp;h=192&amp;s=48413&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>生成了时间戳-Aaa.ts，这个就是放迁移代码的：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a73b0041a8f54139a0b582e783728020~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1536&amp;h=530&amp;s=143425&amp;e=png&amp;b=1e1e1e" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>迁移就是 create table、alter table 这些。</p>
<p>我们在 mysql workbench 里导出下建表 sql 语句：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52255a427e3a42da80dec8709acd8b2a~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=2194&amp;h=1328&amp;s=598835&amp;e=png&amp;b=efefef" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>点击左侧的 Data Export，选中要导出的表，指定一个 sql 文件保存位置，点击 Export。</p>
<p>可以看到，生成的 sql 里就包括了 create table 建表语句和插入数据的 insert into 语句：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9997eaf909de49a1b17b09b775449afb~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1366&amp;h=1030&amp;s=212632&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>我们把建表 sql 拿过来：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a5662c9da5f4bde91ac9e2d7fa619ac~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1312&amp;h=726&amp;s=152394&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MigrationInterface</span>, <span class="hljs-title class_">QueryRunner</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"typeorm"</span>;</span>
<span class="code-block-extension-codeLine" data-line-num="2"></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Aaa1708136448263</span> implements <span class="hljs-title class_">MigrationInterface</span> {</span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5">    public <span class="hljs-keyword">async</span> <span class="hljs-title function_">up</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="6">        <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">query</span>(<span class="hljs-string">`</span></span>
<span class="code-block-extension-codeLine" data-line-num="7">            CREATE TABLE user (</span>
<span class="code-block-extension-codeLine" data-line-num="8">                id int NOT NULL AUTO_INCREMENT,</span>
<span class="code-block-extension-codeLine" data-line-num="9">                firstName varchar(255) NOT NULL,</span>
<span class="code-block-extension-codeLine" data-line-num="10">                lastName varchar(255) NOT NULL,</span>
<span class="code-block-extension-codeLine" data-line-num="11">                PRIMARY KEY (id)</span>
<span class="code-block-extension-codeLine" data-line-num="12">            ) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;    </span>
<span class="code-block-extension-codeLine" data-line-num="13">        `)</span>
<span class="code-block-extension-codeLine" data-line-num="14">    }</span>
<span class="code-block-extension-codeLine" data-line-num="15"></span>
<span class="code-block-extension-codeLine" data-line-num="16">    public <span class="hljs-keyword">async</span> <span class="hljs-title function_">down</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</span>
<span class="code-block-extension-codeLine" data-line-num="17">    }</span>
<span class="code-block-extension-codeLine" data-line-num="18"></span>
<span class="code-block-extension-codeLine" data-line-num="19">}</span>
</code></pre>
<p>然后把 synchronize 关掉，用 migration 来手动建表：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/08f60a08ae094c8096a91710392aec6f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=854&amp;h=730&amp;s=125184&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1"><span class="hljs-keyword">import</span> <span class="hljs-string">"reflect-metadata"</span></span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"typeorm"</span></span>
<span class="code-block-extension-codeLine" data-line-num="3"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./entity/User"</span></span>
<span class="code-block-extension-codeLine" data-line-num="4"></span>
<span class="code-block-extension-codeLine" data-line-num="5"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>({</span>
<span class="code-block-extension-codeLine" data-line-num="6">    <span class="hljs-attr">type</span>: <span class="hljs-string">"mysql"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="7">    <span class="hljs-attr">host</span>: <span class="hljs-string">"localhost"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="8">    <span class="hljs-attr">port</span>: <span class="hljs-number">3306</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="9">    <span class="hljs-attr">username</span>: <span class="hljs-string">"root"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="10">    <span class="hljs-attr">password</span>: <span class="hljs-string">"guang"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="11">    <span class="hljs-attr">database</span>: <span class="hljs-string">"migration-test"</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="12">    <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="13">    <span class="hljs-attr">logging</span>: <span class="hljs-literal">true</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="14">    <span class="hljs-attr">entities</span>: [<span class="hljs-title class_">User</span>],</span>
<span class="code-block-extension-codeLine" data-line-num="15">    <span class="hljs-attr">migrations</span>: [<span class="hljs-string">'./src/migration/**.ts'</span>],</span>
<span class="code-block-extension-codeLine" data-line-num="16">    <span class="hljs-attr">subscribers</span>: [],</span>
<span class="code-block-extension-codeLine" data-line-num="17">    <span class="hljs-attr">poolSize</span>: <span class="hljs-number">10</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="18">    <span class="hljs-attr">connectorPackage</span>: <span class="hljs-string">'mysql2'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="19">    <span class="hljs-attr">extra</span>: {</span>
<span class="code-block-extension-codeLine" data-line-num="20">        <span class="hljs-attr">authPlugin</span>: <span class="hljs-string">'sha256_password'</span>,</span>
<span class="code-block-extension-codeLine" data-line-num="21">    }</span>
<span class="code-block-extension-codeLine" data-line-num="22">})</span>
</code></pre>
<p>先在 mysql workbench 里把之前的表删掉：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/94244a2e659d437eb85c356718e47ad5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=692&amp;h=742&amp;s=212217&amp;e=png&amp;b=e8e3e1" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>把 index.ts 注释放开，但 age 去掉：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f93582406ad405dab7e6ecf32655be0~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1144&amp;h=734&amp;s=171397&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后再跑 npm run start</p>
<p>这时候因为 synchronize 关掉了，不会自动建表，所以 报错了：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f360f578c92943138f36ec33aab18802~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1006&amp;h=596&amp;s=146980&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后我们用 migration:run 来手动建表：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:run -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2ca0da981524e0ab41914ace616159d~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1756&amp;h=680&amp;s=200786&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>可以看到，执行了 migration 里的 create table 语句，并且还在 migration 表里插入了一条记录。</p>
<p>这时候数据库中就有这个表了：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3f19da4a3654f048ad6c07178a305c3~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1060&amp;h=534&amp;s=179560&amp;e=png&amp;b=efeceb" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>并且还在 migrations 表里记录了什么时间执行了什么迁移：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf7c55b2a46644e4b1c2b9ce5b3235f1~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1092&amp;h=404&amp;s=121847&amp;e=png&amp;b=eeeae9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这时候再跑 npm run start</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3011c37d0024400184bf4a6675601022~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1218&amp;h=526&amp;s=110172&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这时候 insert、select 就都成功了。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/129aa88d5f1a459ebba501b860361106~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=932&amp;h=318&amp;s=83367&amp;e=png&amp;b=ede9e8" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>生产环境，我们不会用 synchronize 自动同步，就是用的 migration 的方式来建表。</p>
<p>但是导出建表 sql 再复制到 migration 的 up 方法里挺麻烦的。</p>
<p>有没有简便的方法呢？</p>
<p>有，这就是 migration:generate 命令。</p>
<p>把这两个表删掉：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56fb40cc805d45caad0a2b68313debe2~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=660&amp;h=648&amp;s=193656&amp;e=png&amp;b=e9e5e2" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>把之前那个 migration 也删掉：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc1c1c870682444ca4498666c90eb13f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=450&amp;h=146&amp;s=19162&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>我们这次用 migration:generate 来生成：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">shell</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-shell code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:generate ./src/migration/Aaa -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90d9eadb066747b9999c973546f86eb5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1964&amp;h=294&amp;s=110500&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>生成的 migration 文件如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b5436f71ca2c4b9e85750614126c8943~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1734&amp;h=576&amp;s=141769&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>用 migration:run 执行下：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:run -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c6c0622bd8d4179944a52a3e8ab1ace~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1554&amp;h=508&amp;s=159936&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>然后再跑下 npm run start：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0df3966e223c496a81b9163ca84e8ab4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1428&amp;h=516&amp;s=115993&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/212f5cf26088447f9619889d22f7b82b~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=934&amp;h=224&amp;s=60496&amp;e=png&amp;b=eeeae9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>没啥问题。</p>
<p>这样，就不用自己写 migration 文件了，就很方便。</p>
<p>当然，不只是建表算是 migration，修改表结构也算。</p>
<p>我们在 User 里加一个字段：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75a626605ed44c798f596c2462004ff4~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=648&amp;h=710&amp;s=83839&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">javascript</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-javascript code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">@<span class="hljs-title class_">Column</span>()</span>
<span class="code-block-extension-codeLine" data-line-num="2"><span class="hljs-attr">email</span>: string</span>
</code></pre>
<p>再执行下 migration:generate</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">bash</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:generate ./src/migration/Bbb -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e8a64bcf85a4ad69b89e7a6d48bf244~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1724&amp;h=420&amp;s=92573&amp;e=png&amp;b=181818" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f2de8d2405d4d0b81d6f17a28801174~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1496&amp;h=524&amp;s=138384&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>这时候生成的 migration 就是 alter table 语句。</p>
<p>跑下 migration:run</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">arduino</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-arduino code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:run -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee6caee979624b128b39b2565a41a182~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1684&amp;h=458&amp;s=150524&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>在 migrations 表里记录了 Aaa 跑过，所以这次只会跑 Bbb 的 migration。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/772842295a18453fa138b0b9192bb323~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1046&amp;h=240&amp;s=76276&amp;e=png&amp;b=ede9e8" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/719211ad884b4d729d6889fdefc46747~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1062&amp;h=252&amp;s=94275&amp;e=png&amp;b=ede9e8" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>可以跑 migration 也同样可以撤销：</p>
<pre><div class="code-block-extension-header" style="background-color: rgb(248, 248, 248);"><div class="code-block-extension-headerLeft"><div class="code-block-extension-foldBtn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.924 9.617A1 1 0 0 0 16 9H8a1 1 0 0 0-.707 1.707l4 4a1 1 0 0 0 1.414 0l4-4a1 1 0 0 0 .217-1.09z" data-name="Down"></path></svg></div></div><div class="code-block-extension-headerRight"><span class="code-block-extension-lang">bash</span><div class="code-block-extension-copyCodeBtn">复制代码</div></div></div><code class="hljs language-bash code-block-extension-codeShowNum"><span class="code-block-extension-codeLine" data-line-num="1">npx typeorm-ts-node-esm migration:revert -d ./src/data-source.ts</span>
</code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/60ad07e42e1a46ef840a1724eeec80d5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1460&amp;h=416&amp;s=130222&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>执行 migration:revert 会执行上次的 migration 的 down 方法，并且从 migrations 表里删掉执行记录。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d5203a159f34bd5beeac6810a09b440~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1244&amp;h=514&amp;s=132772&amp;e=png&amp;b=1f1f1f" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/592003038c9742229b6e51b3609ce383~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1142&amp;h=228&amp;s=78542&amp;e=png&amp;b=efebea" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/440a8e23d5cf4e9ea4f7ebf413767d8f~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1064&amp;h=218&amp;s=73362&amp;e=png&amp;b=eeeae9" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>再次 revert，会撤销上一次的 migration，删掉 user 表：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/498436cc8eeb4ea8a1d4243fe81e96f5~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=1492&amp;h=422&amp;s=129300&amp;e=png&amp;b=191919" alt="" loading="lazy" class="medium-zoom-image"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/94abd68ef6164d7c95569e6c0b80ca43~tplv-k3u1fbpfcp-jj-mark:1663:0:0:0:q75.awebp#?w=938&amp;h=224&amp;s=60919&amp;e=png&amp;b=ece8e6" alt="" loading="lazy" class="medium-zoom-image"></p>
<p>所以说，每一次的 migration 都是可控的，可以手动执行、也可以撤销。生产环境我们就是用 migration 来修改表结构，而不是 synchronize</p>
<p>案例代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FQuarkGluonPlasma%2Fnestjs-course-code%2Ftree%2Fmain%2Ftypeorm-migration" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/QuarkGluonPlasma/nestjs-course-code/tree/main/typeorm-migration" ref="nofollow noopener noreferrer">小册仓库</a>。</p>
<h2 data-id="heading-0">总结</h2>
<p>开发环境我们会用 synchronize 来同步 Entity 和数据库表，它会自动执行 create table、alter table，不用手动修改表结构，很方便。</p>
<p>但是它并不安全，因为很容易丢失数据。所以生产环境下我们会把它关掉，用 migration 来管理。</p>
<p>migration 就是把 create table、alter table 等封装成一个个的 migration，可以一步步执行、也可以一步步撤销回去。</p>
<p>有 4 个常用命令：</p>
<ul>
<li>migration:create：生成空白 migration 文件</li>
<li>migration:generate：连接数据库，根据 Entity 和数据库表的差异，生成 migration 文件</li>
<li>migration:run：执行 migration，会根据数据库 migrations 表的记录来确定执行哪个</li>
<li>migration:revert：撤销上次 migration，删掉数据库 migrations 里的上次执行记录</li>
</ul>
<p>这样就把生产环境里的建表和修改表的操作管理了起来。</p></div>